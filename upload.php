<?php
// upload.php
session_start();
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
        exit();
        }
        require_once 'config.php';

        $error = '';

        if ($_SERVER['REQUEST_METHOD'] == 'POST') {
            $caption = trim($_POST['caption']);
                
                    if(isset($_FILES['media'])) {
                            $fileError = $_FILES['media']['error'];

                                    if ($fileError !== UPLOAD_ERR_OK) {
                                                switch ($fileError) {
                                                                case UPLOAD_ERR_INI_SIZE:
                                                                                case UPLOAD_ERR_FORM_SIZE:
                                                                                                    $error = "حجم فایل بیش از حد مجاز است.";
                                                                                                                        break;
                                                                                                                                        case UPLOAD_ERR_PARTIAL:
                                                                                                                                                            $error = "فایل به صورت ناقص آپلود شد.";
                                                                                                                                                                                break;
                                                                                                                                                                                                case UPLOAD_ERR_NO_FILE:
                                                                                                                                                                                                                    $error = "فایلی انتخاب نشده است.";
                                                                                                                                                                                                                                        break;
                                                                                                                                                                                                                                                        case UPLOAD_ERR_NO_TMP_DIR:
                                                                                                                                                                                                                                                                            $error = "پوشه موقتی برای آپلود پیدا نشد.";
                                                                                                                                                                                                                                                                                                break;
                                                                                                                                                                                                                                                                                                                case UPLOAD_ERR_CANT_WRITE:
                                                                                                                                                                                                                                                                                                                                    $error = "نوشتن فایل روی سرور با مشکل مواجه شد.";
                                                                                                                                                                                                                                                                                                                                                        break;
                                                                                                                                                                                                                                                                                                                                                                        case UPLOAD_ERR_EXTENSION:
                                                                                                                                                                                                                                                                                                                                                                                            $error = "آپلود فایل توسط پسوند متوقف شد.";
                                                                                                                                                                                                                                                                                                                                                                                                                break;
                                                                                                                                                                                                                                                                                                                                                                                                                                default:
                                                                                                                                                                                                                                                                                                                                                                                                                                                    $error = "خطای ناشناخته در آپلود فایل رخ داد.";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $allowed = ['jpg', 'jpeg', 'png', 'gif', 'mp4', 'webm', 'ogg'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                $fileName = $_FILES['media']['name'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $fileTmp  = $_FILES['media']['tmp_name'];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        $ext      = strtolower(pathinfo($fileName, PATHINFO_EXTENSION));

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if(in_array($ext, $allowed)){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $newFileName = 'uploads/' . uniqid() . '.' . $ext;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if(move_uploaded_file($fileTmp, $newFileName)){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        $stmt = $conn->prepare("INSERT INTO posts (user_id, media, caption) VALUES (?, ?, ?)");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $stmt->bind_param("iss", $_SESSION['user_id'], $newFileName, $caption);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if($stmt->execute()){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        header("Location: home.php");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                exit();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $error = "خطا در ذخیره پست: " . $stmt->error;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $stmt->close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        $error = "آپلود فایل با مشکل مواجه شد.";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $error = "فرمت فایل مجاز نیست. (jpg, jpeg, png, gif, mp4, webm, ogg)";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    $error = "فایلی انتخاب نشده است.";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ?>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <!DOCTYPE html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <html lang="fa">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <head>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <meta charset="UTF-8">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <title>ارسال پست</title>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <link rel="stylesheet" href="style.css">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </head>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="container">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <h2>ارسال پست</h2>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php if($error): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <p class="error"><?php echo $error; ?></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <form method="post" action="upload.php" enctype="multipart/form-data">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <label>انتخاب فایل (تصویر/ویدیو):</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <input type="file" name="media" required>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <label>کپشن:</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <textarea name="caption" rows="4" required></textarea>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button type="submit">ارسال</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <a href="home.php">بازگشت به خانه</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </html>